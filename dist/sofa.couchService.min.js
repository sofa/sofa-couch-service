/**
 * sofa-couch-service - v0.9.4 - 2014-08-01
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.CouchService",function(b,c,d){var e={},f=new a.comparer.ProductComparer,g=new a.CategoryTreeResolver(b,c,d),h=new a.ProductBatchResolver(b,c,d),i=new a.SingleProductResolver(e,b,c,d),j=new a.ProductDecorator(d),k=new a.CategoryDecorator(d),l=new a.PageInfoFactory(d),m=new a.InMemoryObjectStore,n=new a.InMemoryObjectStore,o=new a.HashService,p=null,q=null,r=d.get("mediaPlaceholder"),s=d.get("useShopUrls",!1);a.observable.mixin(e),e.isAChildAliasOfB=function(b,c){if(!c.children||0===c.children.length)return!1;var d=a.Util.find(c.children,function(a){return a.urlId===b.urlId});return!a.Util.isUndefined(d)},e.isAParentOfB=function(a,b){return b.parent===a||(b.parent&&e.isAParentOfB(a,b.parent))===!0},e.isAChildOfB=function(a,b){return e.isAParentOfB(b,a)},e.createPageInfo=function(a){return l.createPageInfo(a)},e.getCategory=function(a){return a||p?!a&&p?c.when(p.rootCategory):a&&a.length>0&&!p?y().then(function(){return p.getCategory(a)}):a&&a.length>0&&p?c.when(p.getCategory(a)):void 0:y()};var t=function(a){return a.categoryUrlId+a.urlKey};e.getProducts=function(a,b){var c={categoryUrlId:a,config:b};return e.getProductsByRawOptions(c)},e.getProductsById=function(a,b){var c={productIds:a,config:b};return e.getProductsByRawOptions(c)},e.getProductsByRawOptions=function(a){var b=o.hashObject(a);return n.exists(b)?c.when(n.get(b)):h(a).then(function(c){var d=u(c,a),e=m.addOrUpdateBatch(d,t);return e.length>0&&n.addOrUpdate(b,e),e})};var u=function(a,b){return a.map(function(a){return v(a,b)})},v=function(b,c){b=j(b,c);var d=a.Util.extend(new cc.models.Product({mediaPlaceholder:r,useShopUrls:s}),b);return e.emit("productCreated",e,d),d};e.getNextProduct=function(a,b){var c=function(c){var d=x(c,a);if(d>-1){var e=c[d+1],f=!e&&b?c[0]:e||null;return f}};return w(a,b,c)},e.getPreviousProduct=function(a,b){var c=function(a,c){var d=x(a,c);if(d>-1){var e=a[d-1],f=!e&&b?a[a.length-1]:e||null;return f}};return w(a,b,c)};var w=function(a,b,d){var f=n.get(a.categoryUrlId);return f?c.when(d(f,a)):e.getProducts(a.categoryUrlId).then(function(b){return d(b,a)})},x=function(a,b){for(var c=0;c<a.length;c++)if(f(a[c],b))return c;return-1};e.getProduct=function(a,b){var d=a+b;return m.exists(d)?c.when(m.get(d)):i(a,b).then(function(b){var c=v(b,{categoryUrlId:a});return m.addOrUpdate(d,c)})};var y=function(){return q||(q=g().then(function(b){var c=b.data;return p=new a.util.CategoryMap,c=a.Util.extend(c,new cc.models.Category({useShopUrls:s})),p.rootCategory=c,z(c),c})),q},z=function(b){b.urlId="",b.isRoot=!0,e.emit("categoryCreated",e,b);var c=new a.util.TreeIterator(b,"children");c.iterateChildren(function(b,c){b.isRoot=b.isRoot||!1,b.parent=c,b.hasChildren=b.children&&b.children.length>0,b=k(b),b=a.Util.extend(b,new cc.models.Category({useShopUrls:s})),p.addCategory(b),e.emit("categoryCreated",e,b)})};return e}),a.InMemoryObjectStore=function(){var c={},d={};return c.addOrUpdate=function(b,c){return d[b]?a.Util.extend(d[b],c):d[b]=c,d[b]},c.addOrUpdateBatch=function(a,b){var d=[],e={};return a.forEach(function(a){var f=b(a);if(!e[f]){var g=c.addOrUpdate(f,a);d.push(g),e[f]=!0}}),d},c.get=function(a){return d[a]},c.exists=function(a){return c.get(a)!==b},c},a.define("sofa.PageInfoFactory",function(a){var b=a.get("defaultPageSize",10),c=function(a,b){this.size=a,this.from=b};c.prototype.next=function(){return this.from=this.from+this.size,this};var d={};return d.createPageInfo=function(a){return new c(b,a.length-b)},d}),a.define("sofa.CategoryDecorator",function(a){var b=a.get("mediaFolder"),c=a.get("mediaImgExtension");return function(a){return a.image=b+a.urlId+"."+c,a}}),a.define("sofa.CategoryTreeResolver",function(a,b,c){var d=c.get("categoryJson");return function(){return a({method:"get",url:d})}}),a.define("sofa.comparer.ProductComparer",function(){return function(a,b){return a===b||a.urlKey&&b.urlKey&&a.urlKey===b.urlKey||a.id&&b.id&&a.id===b.id}}),a.HashService=function(){var a={};return a.hashString=function(a){var b,c,d,e=0;if(0===a.length)return e;for(b=0,d=a.length;d>b;b++)c=a.charCodeAt(b),e=(e<<5)-e+c,e|=0;return e.toString()},a.hashObject=function(b){return a.hashString(JSON.stringify(b))},a},a.define("sofa.util.CategoryMap",function(){var a={},b={};return a.addCategory=function(a){b[a.urlId]?a.children&&a.children.length>0&&(b[a.urlId]=a):b[a.urlId]=a},a.getCategory=function(a){return b[a]},a}),a.define("sofa.ProductBatchResolver",function(a,b,c){var d=c.get("apiUrl"),e=c.get("apiHttpMethod","jsonp"),f=c.get("storeCode");return function(b){if(b.productIds)throw new Error("Batch loading of products by id is not supported. Consider overwriting ProductBatchResolver");return a({method:e,url:d+"?&stid="+f+"&cat="+b.categoryUrlId+"&callback=JSON_CALLBACK"}).then(function(a){return a.data.products})}}),a.define("sofa.ProductDecorator",function(){return function(a,b){return a.categoryUrlId=b&&b.categoryUrlId,a.price=parseFloat(a.price,10),a}}),a.define("sofa.SingleProductResolver",function(a){return function(b,c){return a.getProducts(b).then(function(d){return d.length>0?a.getProduct(b,c):null})}})}(sofa);