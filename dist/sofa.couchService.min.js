/**
 * sofa-couch-service - v0.2.0 - 2014-04-28
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a){"use strict";a.define("sofa.CouchService",function(b,c,d){var e={},f={},g=new a.comparer.ProductComparer,h=null,i=null,j=d.get("mediaFolder"),k=d.get("mediaImgExtension"),l=d.get("apiUrl"),m=d.get("apiHttpMethod","jsonp"),n=d.get("storeCode"),o=d.get("categoryJson");a.observable.mixin(e),e.isAChildAliasOfB=function(b,c){if(!c.children||0===c.children.length)return!1;var d=a.Util.find(c.children,function(a){return a.urlId===b.urlId});return!a.Util.isUndefined(d)},e.isAParentOfB=function(a,b){return b.parent===a||(b.parent&&e.isAParentOfB(a,b.parent))===!0},e.isAChildOfB=function(a,b){return e.isAParentOfB(b,a)},e.getCategory=function(a){return a||h?!a&&h?c.when(h.rootCategory):a&&a.length>0&&!h?t().then(function(){return h.getCategory(a)}):a&&a.length>0&&h?c.when(h.getCategory(a)):void 0:t()},e.getProducts=function(a){return f[a]?c.when(f[a]):b({method:m,url:l+"?&stid="+n+"&cat="+a+"&callback=JSON_CALLBACK"}).then(function(b){var c=p(b.data.products,a);return f[a]=c,c})};var p=function(b,c){return b.map(function(b){b.categoryUrlId=c,b.price=parseFloat(b.price,10);var d=a.Util.extend(new cc.models.Product,b);return e.emit("productCreated",e,d),d})};e.getNextProduct=function(a,b){var c=function(c){var d=r(c,a);if(d>-1){var e=c[d+1],f=!e&&b?c[0]:e||null;return f}};return q(a,b,c)},e.getPreviousProduct=function(a,b){var c=function(a,c){var d=r(a,c);if(d>-1){var e=a[d-1],f=!e&&b?a[a.length-1]:e||null;return f}};return q(a,b,c)};var q=function(a,b,d){var g=f[a.categoryUrlId];return g?c.when(d(g,a)):e.getProducts(a.categoryUrlId).then(function(b){return d(b,a)})},r=function(a,b){for(var c=0;c<a.length;c++)if(g(a[c],b))return c;return-1};e.getProduct=function(a,b){return f[a]?c.when(s(f[a],b)):e.getProducts(a).then(function(a){return s(a,b)})};var s=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.urlKey===b)return d}return null},t=function(){return i||(i=b({method:"get",url:o}).then(function(b){var c=b.data;return h=new a.util.CategoryMap,h.rootCategory=c,u(c),c})),i},u=function(b){b.urlId="",b.isRoot=!0,e.emit("categoryCreated",e,b);var c=new a.util.TreeIterator(b,"children");c.iterateChildren(function(a,b){a.isRoot=a.isRoot||!1,a.parent=b,a.image=j+a.urlId+"."+k,a.hasChildren=a.children&&a.children.length>0,h.addCategory(a),e.emit("categoryCreated",e,a)})};return e}),a.define("sofa.comparer.ProductComparer",function(){return function(a,b){return a===b||a.urlKey&&b.urlKey&&a.urlKey===b.urlKey||a.id&&b.id&&a.id===b.id}}),a.define("sofa.util.CategoryMap",function(){var a={},b={};return a.addCategory=function(a){b[a.urlId]?a.children&&a.children.length>0&&(b[a.urlId]=a):b[a.urlId]=a},a.getCategory=function(a){return b[a]},a})}(sofa);