/**
 * sofa-couch-service - v0.5.0 - 2014-07-14
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a){"use strict";a.define("sofa.CouchService",function(b,c,d){var e={},f={},g=new a.comparer.ProductComparer,h=new a.CategoryTreeResolver(b,c,d),i=null,j=null,k=d.get("mediaFolder"),l=d.get("mediaImgExtension"),m=d.get("mediaPlaceholder"),n=d.get("useShopUrls",!1),o=d.get("apiUrl"),p=d.get("apiHttpMethod","jsonp"),q=d.get("storeCode");a.observable.mixin(e),e.isAChildAliasOfB=function(b,c){if(!c.children||0===c.children.length)return!1;var d=a.Util.find(c.children,function(a){return a.urlId===b.urlId});return!a.Util.isUndefined(d)},e.isAParentOfB=function(a,b){return b.parent===a||(b.parent&&e.isAParentOfB(a,b.parent))===!0},e.isAChildOfB=function(a,b){return e.isAParentOfB(b,a)},e.getCategory=function(a){return a||i?!a&&i?c.when(i.rootCategory):a&&a.length>0&&!i?v().then(function(){return i.getCategory(a)}):a&&a.length>0&&i?c.when(i.getCategory(a)):void 0:v()},e.getProducts=function(a){return f[a]?c.when(f[a]):b({method:p,url:o+"?&stid="+q+"&cat="+a+"&callback=JSON_CALLBACK"}).then(function(b){var c=r(b.data.products,a);return f[a]=c,c})};var r=function(b,c){return b.map(function(b){b.categoryUrlId=c,b.price=parseFloat(b.price,10);var d=a.Util.extend(new cc.models.Product({mediaPlaceholder:m,useShopUrls:n}),b);return e.emit("productCreated",e,d),d})};e.getNextProduct=function(a,b){var c=function(c){var d=t(c,a);if(d>-1){var e=c[d+1],f=!e&&b?c[0]:e||null;return f}};return s(a,b,c)},e.getPreviousProduct=function(a,b){var c=function(a,c){var d=t(a,c);if(d>-1){var e=a[d-1],f=!e&&b?a[a.length-1]:e||null;return f}};return s(a,b,c)};var s=function(a,b,d){var g=f[a.categoryUrlId];return g?c.when(d(g,a)):e.getProducts(a.categoryUrlId).then(function(b){return d(b,a)})},t=function(a,b){for(var c=0;c<a.length;c++)if(g(a[c],b))return c;return-1};e.getProduct=function(a,b){return f[a]?c.when(u(f[a],b)):e.getProducts(a).then(function(a){return u(a,b)})};var u=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.urlKey===b)return d}return null},v=function(){return j||(j=h().then(function(b){var c=b.data;return i=new a.util.CategoryMap,c=a.Util.extend(c,new cc.models.Category({useShopUrls:n})),i.rootCategory=c,w(c),c})),j},w=function(b){b.urlId="",b.isRoot=!0,e.emit("categoryCreated",e,b);var c=new a.util.TreeIterator(b,"children");c.iterateChildren(function(b,c){b.isRoot=b.isRoot||!1,b.parent=c,b.image=k+b.urlId+"."+l,b.hasChildren=b.children&&b.children.length>0,b=a.Util.extend(b,new cc.models.Category({useShopUrls:n})),i.addCategory(b),e.emit("categoryCreated",e,b)})};return e}),a.define("sofa.CategoryTreeResolver",function(a,b,c){var d=c.get("categoryJson");return function(){return a({method:"get",url:d})}}),a.define("sofa.comparer.ProductComparer",function(){return function(a,b){return a===b||a.urlKey&&b.urlKey&&a.urlKey===b.urlKey||a.id&&b.id&&a.id===b.id}}),a.define("sofa.util.CategoryMap",function(){var a={},b={};return a.addCategory=function(a){b[a.urlId]?a.children&&a.children.length>0&&(b[a.urlId]=a):b[a.urlId]=a},a.getCategory=function(a){return b[a]},a})}(sofa);