/**
 * sofa-couch-service - v0.7.0 - 2014-07-23
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.CouchService",function(b,c,d){var e={},f=new a.comparer.ProductComparer,g=new a.CategoryTreeResolver(b,c,d),h=new a.ProductBatchResolver(b,c,d),i=new a.SingleProductResolver(e,b,c,d),j=new a.ProductDecorator(d),k=new a.InMemoryObjectStore,l=new a.InMemoryObjectStore,m=new a.HashService,n=null,o=null,p=d.get("mediaFolder"),q=d.get("mediaImgExtension"),r=d.get("mediaPlaceholder"),s=d.get("useShopUrls",!1);a.observable.mixin(e),e.isAChildAliasOfB=function(b,c){if(!c.children||0===c.children.length)return!1;var d=a.Util.find(c.children,function(a){return a.urlId===b.urlId});return!a.Util.isUndefined(d)},e.isAParentOfB=function(a,b){return b.parent===a||(b.parent&&e.isAParentOfB(a,b.parent))===!0},e.isAChildOfB=function(a,b){return e.isAParentOfB(b,a)},e.getCategory=function(a){return a||n?!a&&n?c.when(n.rootCategory):a&&a.length>0&&!n?x().then(function(){return n.getCategory(a)}):a&&a.length>0&&n?c.when(n.getCategory(a)):void 0:x()};var t=function(a){return a.categoryUrlId+a.urlKey};e.getProducts=function(a,b){var d=m.hashObject({categoryUrlId:a,config:b});return l.exists(d)?c.when(l.get(d)):h(a,b).then(function(b){var c=u(b,a),e=k.addOrUpdateBatch(c,t);return l.addOrUpdate(d,e),e})};var u=function(b,c){return b.map(function(b){b=j(b),b.categoryUrlId=c;var d=a.Util.extend(new cc.models.Product({mediaPlaceholder:r,useShopUrls:s}),b);return e.emit("productCreated",e,d),d})};e.getNextProduct=function(a,b){var c=function(c){var d=w(c,a);if(d>-1){var e=c[d+1],f=!e&&b?c[0]:e||null;return f}};return v(a,b,c)},e.getPreviousProduct=function(a,b){var c=function(a,c){var d=w(a,c);if(d>-1){var e=a[d-1],f=!e&&b?a[a.length-1]:e||null;return f}};return v(a,b,c)};var v=function(a,b,d){var f=l.get(a.categoryUrlId);return f?c.when(d(f,a)):e.getProducts(a.categoryUrlId).then(function(b){return d(b,a)})},w=function(a,b){for(var c=0;c<a.length;c++)if(f(a[c],b))return c;return-1};e.getProduct=function(a,b){var d=a+b;return k.exists(d)?c.when(k.get(d)):i(a,b)};var x=function(){return o||(o=g().then(function(b){var c=b.data;return n=new a.util.CategoryMap,c=a.Util.extend(c,new cc.models.Category({useShopUrls:s})),n.rootCategory=c,y(c),c})),o},y=function(b){b.urlId="",b.isRoot=!0,e.emit("categoryCreated",e,b);var c=new a.util.TreeIterator(b,"children");c.iterateChildren(function(b,c){b.isRoot=b.isRoot||!1,b.parent=c,b.image=p+b.urlId+"."+q,b.hasChildren=b.children&&b.children.length>0,b=a.Util.extend(b,new cc.models.Category({useShopUrls:s})),n.addCategory(b),e.emit("categoryCreated",e,b)})};return e}),a.InMemoryObjectStore=function(){var c={},d={};return c.addOrUpdate=function(b,c){return d[b]?a.Util.extend(d[b],c):d[b]=c,d[b]},c.addOrUpdateBatch=function(a,b){var d=[],e={};return a.forEach(function(a){var f=b(a);if(!e[f]){var g=c.addOrUpdate(f,a);d.push(g),e[f]=!0}}),d},c.get=function(a){return d[a]},c.exists=function(a){return c.get(a)!==b},c},a.define("sofa.CategoryTreeResolver",function(a,b,c){var d=c.get("categoryJson");return function(){return a({method:"get",url:d})}}),a.define("sofa.comparer.ProductComparer",function(){return function(a,b){return a===b||a.urlKey&&b.urlKey&&a.urlKey===b.urlKey||a.id&&b.id&&a.id===b.id}}),a.HashService=function(){var a={};return a.hashString=function(a){var b,c,d,e=0;if(0===a.length)return e;for(b=0,d=a.length;d>b;b++)c=a.charCodeAt(b),e=(e<<5)-e+c,e|=0;return e.toString()},a.hashObject=function(b){return a.hashString(JSON.stringify(b))},a},a.define("sofa.util.CategoryMap",function(){var a={},b={};return a.addCategory=function(a){b[a.urlId]?a.children&&a.children.length>0&&(b[a.urlId]=a):b[a.urlId]=a},a.getCategory=function(a){return b[a]},a}),a.define("sofa.ProductBatchResolver",function(a,b,c){var d=c.get("apiUrl"),e=c.get("apiHttpMethod","jsonp"),f=c.get("storeCode");return function(b){return a({method:e,url:d+"?&stid="+f+"&cat="+b+"&callback=JSON_CALLBACK"}).then(function(a){return a.data.products})}}),a.define("sofa.ProductDecorator",function(){return function(a){return a.price=parseFloat(a.price,10),a}}),a.define("sofa.SingleProductResolver",function(a){return function(b,c){return a.getProducts(b).then(function(){return a.getProduct(b,c)})}})}(sofa);