/**
 * sofa-couch-service - v0.14.1 - 2015-02-24
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.CouchService",function(b,c,d){var e={},f=new a.CategoryTreeResolver(b,c,d),g=new a.ProductBatchResolver(b,c,d),h=new a.SingleProductResolver(e,b,c,d),i=new a.ProductDecorator(d),j=new a.CategoryDecorator(d),k=new a.PageInfoFactory(d),l=new a.InMemoryObjectStore,m=new a.InMemoryObjectStore,n=new a.HashService,o=null,p=null,q=d.get("mediaPlaceholder"),r=d.get("useShopUrls",!1);a.observable.mixin(e),e.isAParentOfB=function(a,b){return b.parent===a||(b.parent&&e.isAParentOfB(a,b.parent))===!0},e.isAChildOfB=function(a,b){return e.isAParentOfB(b,a)},e.createPageInfo=function(a){return a?k.createPageInfo(a):k.createFirstPageInfo()},e.getCategory=function(a){return a||o?!a&&o?c.when(o.rootCategory):a&&a.length>0&&!o?u().then(function(){return o.getCategory(a)}):a&&a.length>0&&o?c.when(o.getCategory(a)):void 0:u()},e.getProducts=function(a,b){var c={categoryId:a,config:b};return e.getProductsByRawOptions(c)},e.getProductsById=function(a,b){var c={productIds:a,config:b};return e.getProductsByRawOptions(c)},e.getProductsByRawOptions=function(b){var d=n.hashObject(b),e=function(a){return a.id};return m.exists(d)?c.when(m.get(d)):g(b).then(function(c){var f=a.Util.isArray(c),g=f?c:c.items,h=s(g,b),i=l.addOrUpdateBatch(h,e);return i.length>0&&m.addOrUpdate(d,f?i:{items:i,meta:c.meta}),f?i:{items:i,meta:c.meta}})};var s=function(a,b){return a.map(function(a){return t(a,b)})},t=function(b){b=i(b);var c=a.Util.extend(new cc.models.Product({mediaPlaceholder:q,useShopUrls:r}),b);return e.emit("productCreated",e,c),c};e.getProduct=function(a){return l.exists(a)?c.when(l.get(a)):h(a).then(function(b){if(!b)return b;var c=t(b);return l.addOrUpdate(a,c)})};var u=function(){return p||(p=f().then(function(b){var c=b.data;return o=new a.util.CategoryMap,c=a.Util.extend(c,new cc.models.Category({useShopUrls:r})),o.rootCategory=c,v(c),c})),p},v=function(b){b.id="",b.isRoot=!0,e.emit("categoryCreated",e,b);var c=new a.util.TreeIterator(b,"children");c.iterateChildren(function(b,c){b.isRoot=b.isRoot||!1,b.parent=c,b.hasChildren=b.children&&b.children.length>0,b=j(b),b=a.Util.extend(b,new cc.models.Category({useShopUrls:r})),o.addCategory(b),e.emit("categoryCreated",e,b)})};return e}),a.InMemoryObjectStore=function(){var c={},d={};return c.addOrUpdate=function(b,c){return d[b]?a.Util.extend(d[b],c):d[b]=c,d[b]},c.addOrUpdateBatch=function(a,b){var d=[],e={};return a.forEach(function(a){var f=b(a);if(!e[f]){var g=c.addOrUpdate(f,a);d.push(g),e[f]=!0}}),d},c.get=function(a){return d[a]},c.exists=function(a){return c.get(a)!==b},c},a.define("sofa.PageInfoFactory",function(a){var b=a.get("defaultPageSize",10),c=function(a,b){this.size=a,this.from=b};c.prototype.next=function(){return this.from=this.from+this.size,this};var d={};return d.createPageInfo=function(a){return new c(b,a.length-b)},d.createFirstPageInfo=function(){return new c(b,0)},d}),a.define("sofa.CategoryDecorator",function(a){var b=a.get("mediaFolder"),c=a.get("mediaImgExtension");return function(a){return a.image=b+a.id+"."+c,a}}),a.CategoryTreeResolver=function(a,b,c){var d=c.get("esEndpoint")+"category/_search",e=function(a,b){return a.filter(function(a){return a.level===b})},f=function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=g(a,d.id);d.children=e}},g=function(a,b){return a.filter(function(a){return a.parentId===b})},h=function(a){var b=a.filter(function(a){return 2===a.level});return b[0].parentId};return function(){return a({method:"POST",url:d,data:{size:1e5,query:{filtered:{filter:{term:{active:!0}}}}}}).then(function(a){for(var b=a.data.hits.hits,c=b.map(function(a){return a._source.label=a._source.name,a._source}),d={label:"",id:h(c),route:"/",children:[]},g=2,i=e(c,g),j=[d];i.length>0;)f(i,j),g++,j=i,i=e(c,g);return{data:d}})}},a.define("sofa.comparer.ProductComparer",function(){return function(a,b){return a===b||a.id&&b.id&&a.id===b.id}}),a.HashService=function(){var a={};return a.hashString=function(a){var b,c,d,e=0;if(0===a.length)return e;for(b=0,d=a.length;d>b;b++)c=a.charCodeAt(b),e=(e<<5)-e+c,e|=0;return e.toString()},a.hashObject=function(b){return a.hashString(JSON.stringify(b))},a},a.define("sofa.util.CategoryMap",function(){var a={},b={};return a.addCategory=function(a){b[a.id]||(b[a.id]=a)},a.getCategory=function(a){return b[a]},a}),a.ProductBatchResolver=function(a,b,c){var d={};return function(b){var e=b.config||d,f=c.get("loggingEnabled")?"?pretty=true":"",g=c.get("esEndpoint")+"product/_search"+f,h={};if(b.productIds){var i=b.productIds.map(function(a){return{term:{id:a}}});h={query:{filtered:{filter:{bool:{should:i}}}}}}else b.categoryId?(h={query:{nested:{path:"categories",query:{match:{"categories.id":b.categoryId}}}}},e.sort&&(h.sort=e.sort)):h=b;return a({method:"POST",url:g,data:h}).then(function(a){return{items:a.data.hits.hits,meta:{total:a.data.hits.total,size:a.config.data.size,from:a.config.data.from}}})}},a.ProductDecorator=function(){return function(a){return a=a._source,a.attributes={},a}},a.define("sofa.SingleProductResolver",function(a,b,c,d){var e=d.get("esEndpoint")+"product/_search?size=1";return function(a){return b({method:"POST",url:e,data:{query:{filtered:{filter:{term:{id:a}}}}}}).then(function(a){return a.data.hits.hits.length>0?a.data.hits.hits[0]:null})}})}(sofa);