/**
 * sofa-couch-service - v0.14.1 - Thu Feb 05 2015 11:21:51 GMT+0100 (CET)
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(e,r,t){"use strict";e.InMemoryObjectStore=function(){var r={},n={};return r.addOrUpdate=function(r,t){return n[r]?e.Util.extend(n[r],t):n[r]=t,n[r]},r.addOrUpdateBatch=function(e,t){var n=[],o={};return e.forEach(function(e){var u=t(e);if(!o[u]){var i=r.addOrUpdate(u,e);n.push(i),o[u]=!0}}),n},r.get=function(e){return n[e]},r.exists=function(e){return r.get(e)!==t},r},e.define("sofa.PageInfoFactory",function(e){var r=e.get("defaultPageSize",10),t=function(e,r){this.size=e,this.from=r};t.prototype.next=function(){return this.from=this.from+this.size,this};var n={};return n.createPageInfo=function(e){return new t(r,e.length-r)},n.createFirstPageInfo=function(){return new t(r,0)},n}),e.define("sofa.CategoryDecorator",function(e){var r=e.get("mediaFolder"),t=e.get("mediaImgExtension");return function(e){return e.image=r+e.urlId+"."+t,e}}),e.define("sofa.CategoryTreeResolver",function(e,r,t){var n=t.get("categoryJson");return function(){return e({method:"get",url:n})}}),e.define("sofa.comparer.ProductComparer",function(){return function(e,r){return e===r||e.urlKey&&r.urlKey&&e.urlKey===r.urlKey||e.id&&r.id&&e.id===r.id}}),e.define("sofa.CouchService",function(r,t,n){var o={},u=new e.comparer.ProductComparer,i=new e.CategoryTreeResolver(r,t,n),a=new e.ProductBatchResolver(r,t,n),c=new e.SingleProductResolver(o,r,t,n),d=new e.ProductDecorator(n),f=new e.CategoryDecorator(n),s=new e.PageInfoFactory(n),l=new e.InMemoryObjectStore,g=new e.InMemoryObjectStore,h=new e.HashService,v=null,y=null,p=n.get("mediaPlaceholder"),P=n.get("useShopUrls",!1);e.observable.mixin(o),o.isAChildAliasOfB=function(r,t){if(!t.children||0===t.children.length)return!1;var n=e.Util.find(t.children,function(e){return e.urlId===r.urlId});return!e.Util.isUndefined(n)},o.isAParentOfB=function(e,r){return r.parent===e||(r.parent&&o.isAParentOfB(e,r.parent))===!0},o.isAChildOfB=function(e,r){return o.isAParentOfB(r,e)},o.createPageInfo=function(e){return e?s.createPageInfo(e):s.createFirstPageInfo()},o.getCategory=function(e){return e||v?!e&&v?t.when(v.rootCategory):e&&e.length>0&&!v?O().then(function(){return v.getCategory(e)}):e&&e.length>0&&v?t.when(v.getCategory(e)):void 0:O()};var m=function(e){return e.categoryUrlId+e.urlKey};o.getProducts=function(e,r){var t={categoryUrlId:e,config:r};return o.getProductsByRawOptions(t)},o.getProductsById=function(e,r){var t={productIds:e,config:r};return o.getProductsByRawOptions(t)},o.getProductsByRawOptions=function(r){var n=h.hashObject(r);return g.exists(n)?t.when(g.get(n)):a(r).then(function(t){var o=e.Util.isArray(t),u=o?t:t.items,i=C(u,r),a=l.addOrUpdateBatch(i,m);return a.length>0&&g.addOrUpdate(n,o?a:{items:a,meta:t.meta}),o?a:{items:a,meta:t.meta}})};var C=function(e,r){return e.map(function(e){return I(e,r)})},I=function(r,t){r=d(r,t);var n=e.Util.extend(new cc.models.Product({mediaPlaceholder:p,useShopUrls:P}),r);return o.emit("productCreated",o,n),n};o.getNextProduct=function(e,r){var t=function(t){var n=U(t,e);if(n>-1){var o=t[n+1],u=!o&&r?t[0]:o||null;return u}};return w(e,r,t)},o.getPreviousProduct=function(e,r){var t=function(e,t){var n=U(e,t);if(n>-1){var o=e[n-1],u=!o&&r?e[e.length-1]:o||null;return u}};return w(e,r,t)};var w=function(e,r,n){var u=g.get(e.categoryUrlId);return u?t.when(n(u,e)):o.getProducts(e.categoryUrlId).then(function(r){return n(r,e)})},U=function(e,r){for(var t=0;t<e.length;t++)if(u(e[t],r))return t;return-1};o.isProductCached=function(e,r){var t=e+r;return l.exists(t)},o.getProduct=function(e,r){var n=e+r;return o.isProductCached(e,r)?t.when(l.get(n)):c(e,r).then(function(r){if(!r)return r;var t=I(r,{categoryUrlId:e});return l.addOrUpdate(n,t)})};var O=function(){return y||(y=i().then(function(r){var t=r.data;return v=new e.util.CategoryMap,t=e.Util.extend(t,new cc.models.Category({useShopUrls:P})),v.rootCategory=t,S(t),t})),y},S=function(r){r.urlId="",r.isRoot=!0,o.emit("categoryCreated",o,r);var t=new e.util.TreeIterator(r,"children");t.iterateChildren(function(r,t){r.isRoot=r.isRoot||!1,r.parent=t,r.hasChildren=r.children&&r.children.length>0,r=f(r),r=e.Util.extend(r,new cc.models.Category({useShopUrls:P})),v.addCategory(r),o.emit("categoryCreated",o,r)})};return o}),e.HashService=function(){var e={};return e.hashString=function(e){var r,t,n,o=0;if(0===e.length)return o;for(r=0,n=e.length;n>r;r++)t=e.charCodeAt(r),o=(o<<5)-o+t,o|=0;return o.toString()},e.hashObject=function(r){return e.hashString(JSON.stringify(r))},e},e.define("sofa.util.CategoryMap",function(){var e={},r={};return e.addCategory=function(e){r[e.urlId]?e.children&&e.children.length>0&&(r[e.urlId]=e):r[e.urlId]=e},e.getCategory=function(e){return r[e]},e}),e.define("sofa.ProductBatchResolver",function(e,r,t){var n=t.get("apiUrl"),o=t.get("apiHttpMethod","jsonp"),u=t.get("storeCode");return function(r){if(r.productIds)throw new Error("Batch loading of products by id is not supported. Consider overwriting ProductBatchResolver");return e({method:o,url:n+"?&stid="+u+"&cat="+r.categoryUrlId+"&callback=JSON_CALLBACK"}).then(function(e){return e.data.products})}}),e.define("sofa.ProductDecorator",function(){return function(e,r){return e.categoryUrlId=r&&r.categoryUrlId,e.price=parseFloat(e.price,10),e}}),e.define("sofa.SingleProductResolver",function(e){return function(r,t){return e.getProducts(r).then(function(){return e.isProductCached(r,t)?e.getProduct(r,t):null})}})}(sofa,document);