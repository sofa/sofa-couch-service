/**
 * sofa-couch-service - v0.14.1 - Wed Apr 22 2015 14:15:23 GMT+0200 (CEST)
 * 
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(t,e,r){"use strict";t.InMemoryObjectStore=function(){var e={},n={};return e.addOrUpdate=function(e,r){return n[e]?t.Util.extend(n[e],r):n[e]=r,n[e]},e.addOrUpdateBatch=function(t,r){var n=[],o={};return t.forEach(function(t){var i=r(t);if(!o[i]){var a=e.addOrUpdate(i,t);n.push(a),o[i]=!0}}),n},e.get=function(t){return n[t]},e.exists=function(t){return e.get(t)!==r},e},t.define("sofa.PageInfoFactory",function(t){var e=t.get("defaultPageSize",10),r=function(t,e){this.size=t,this.from=e};r.prototype.next=function(){return this.from=this.from+this.size,this};var n={};return n.createPageInfo=function(t){return new r(e,t.length-e)},n.createFirstPageInfo=function(){return new r(e,0)},n}),t.define("sofa.CategoryDecorator",function(t){var e=t.get("mediaFolder"),r=t.get("mediaImgExtension");return function(t){return t.image=e+t.id+"."+r,t}}),t.CategoryTreeResolver=function(t,e,r){var n=r.get("esEndpoint")+"category/_search",o=function(t,e){return t.filter(function(t){return t.level===e})},i=function(t,e){for(var r=0;r<e.length;r++){var n=e[r],o=a(t,n.id);n.children=o}},a=function(t,e){return t.filter(function(t){return t.parentId===e})},u=function(t){var e=t.filter(function(t){return 2===t.level});return e[0].parentId};return function(){return t({method:"POST",url:n,data:{size:1e5,query:{filtered:{filter:{term:{active:!0}}}}}}).then(function(t){for(var e=t.data.hits.hits,r=e.map(function(t){return t._source.label=t._source.name,t._source}),n={label:"",id:u(r),route:"/",children:[]},a=2,c=o(r,a),d=[n];c.length>0;)i(c,d),a++,d=c,c=o(r,a);return{data:n}})}},t.define("sofa.comparer.ProductComparer",function(){return function(t,e){return t===e||t.id&&e.id&&t.id===e.id}}),t.define("sofa.CouchService",function(e,r,n){var o={},i=new t.CategoryTreeResolver(e,r,n),a=new t.ProductBatchResolver(e,r,n),u=new t.SingleProductResolver(o,e,r,n),c=new t.ProductDecorator(n),d=new t.CategoryDecorator(n),f=new t.PageInfoFactory(n),s=new t.InMemoryObjectStore,g=new t.InMemoryObjectStore,l=new t.HashService,h=null,m=null,v=n.get("mediaPlaceholder"),p=n.get("useShopUrls",!1);t.observable.mixin(o),o.isAParentOfB=function(t,e){return e.parent===t||(e.parent&&o.isAParentOfB(t,e.parent))===!0},o.isAChildOfB=function(t,e){return o.isAParentOfB(e,t)},o.createPageInfo=function(t){return t?f.createPageInfo(t):f.createFirstPageInfo()},o.getCategory=function(t){return t||h?!t&&h?r.when(h.rootCategory):t&&t.length>0&&!h?C().then(function(){return h.getCategory(t)}):t&&t.length>0&&h?r.when(h.getCategory(t)):void 0:C()},o.getProducts=function(t,e){var r={categoryId:t,config:e};return o.getProductsByRawOptions(r)},o.getProductsById=function(t,e){var r={productIds:t,config:e};return o.getProductsByRawOptions(r)},o.getProductsByRawOptions=function(e){var n=l.hashObject(e),o=function(t){return t.id};return g.exists(n)?r.when(g.get(n)):a(e).then(function(r){var i=t.Util.isArray(r),a=i?r:r.items,u=y(a,e),c=s.addOrUpdateBatch(u,o);return c.length>0&&g.addOrUpdate(n,i?c:{items:c,meta:r.meta}),i?c:{items:c,meta:r.meta}})};var y=function(t,e){return t.map(function(t){return P(t,e)})},P=function(e){e=c(e);var r=t.Util.extend(new cc.models.Product({mediaPlaceholder:v,useShopUrls:p}),e);return o.emit("productCreated",o,r),r};o.getProduct=function(t){return s.exists(t)?r.when(s.get(t)):u(t).then(function(e){if(!e)return e;var r=P(e);return s.addOrUpdate(t,r)})};var C=function(){return m||(m=i().then(function(e){var r=e.data;return h=new t.util.CategoryMap,r=t.Util.extend(r,new cc.models.Category({useShopUrls:p})),h.rootCategory=r,w(r),r})),m},w=function(e){e.id="",e.isRoot=!0,o.emit("categoryCreated",o,e);var r=new t.util.TreeIterator(e,"children");r.iterateChildren(function(e,r){e.isRoot=e.isRoot||!1,e.parent=r,e.hasChildren=e.children&&e.children.length>0,e=d(e),e=t.Util.extend(e,new cc.models.Category({useShopUrls:p})),h.addCategory(e),o.emit("categoryCreated",o,e)})};return o}),t.HashService=function(){var t={};return t.hashString=function(t){var e,r,n,o=0;if(0===t.length)return o;for(e=0,n=t.length;n>e;e++)r=t.charCodeAt(e),o=(o<<5)-o+r,o|=0;return o.toString()},t.hashObject=function(e){return t.hashString(JSON.stringify(e))},t},t.define("sofa.util.CategoryMap",function(){var t={},e={};return t.addCategory=function(t){e[t.id]||(e[t.id]=t)},t.getCategory=function(t){return e[t]},t}),t.ProductBatchResolver=function(t,e,r){var n={};return function(e){var o=e.config||n,i=r.get("loggingEnabled")?"?pretty=true":"",a=r.get("esEndpoint")+"product/_search"+i,u={};if(e.productIds){var c=e.productIds.map(function(t){return{term:{id:t}}});u={query:{filtered:{filter:{bool:{should:c}}}}}}else e.categoryId?(u={query:{nested:{path:"categories",query:{match:{"categories.id":e.categoryId}}}}},o.sort&&(u.sort=o.sort)):u=e;return t({method:"POST",url:a,data:u}).then(function(t){return{items:t.data.hits.hits,meta:{total:t.data.hits.total,size:t.config.data.size,from:t.config.data.from}}})}},t.ProductDecorator=function(){return function(t){return t=t._source,t.attributes={},t}},t.define("sofa.SingleProductResolver",function(t,e,r,n){var o=n.get("esEndpoint")+"product/_search?size=1";return function(t){return e({method:"POST",url:o,data:{query:{filtered:{filter:{term:{id:t}}}}}}).then(function(t){return t.data.hits.hits.length>0?t.data.hits.hits[0]:null})}})}(sofa,document);